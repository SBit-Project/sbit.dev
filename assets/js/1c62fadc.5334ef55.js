"use strict";(self.webpackChunksbit_website=self.webpackChunksbit_website||[]).push([[4979],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return m}});var a=n(7294);function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){l(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,l=function(e,t){if(null==e)return{};var n,a,l={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(l[n]=e[n]);return l}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(l[n]=e[n])}return l}var i=a.createContext({}),d=function(e){var t=a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},c=function(e){var t=d(e.components);return a.createElement(i.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,l=e.mdxType,o=e.originalType,i=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=d(n),m=l,k=u["".concat(i,".").concat(m)]||u[m]||p[m]||o;return n?a.createElement(k,r(r({ref:t},c),{},{components:n})):a.createElement(k,r({ref:t},c))}));function m(e,t){var n=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var o=n.length,r=new Array(o);r[0]=u;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s.mdxType="string"==typeof e?e:l,r[1]=s;for(var d=2;d<o;d++)r[d]=n[d];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},5749:function(e,t,n){n.r(t),n.d(t,{assets:function(){return c},contentTitle:function(){return i},default:function(){return m},frontMatter:function(){return s},metadata:function(){return d},toc:function(){return p}});var a=n(7462),l=n(3366),o=(n(7294),n(3905)),r=["components"],s={title:"Complex Crowdsale",description:"Holding A Crowdsale",keywords:["sbit","ico","smart contract","token"],sidebar_position:5},i=void 0,d={unversionedId:"Smart-Contract/SRC20/ico",id:"Smart-Contract/SRC20/ico",title:"Complex Crowdsale",description:"Holding A Crowdsale",source:"@site/docs/Smart-Contract/SRC20/ico.md",sourceDirName:"Smart-Contract/SRC20",slug:"/Smart-Contract/SRC20/ico",permalink:"/sbit.dev/docs/Smart-Contract/SRC20/ico",tags:[],version:"current",sidebarPosition:5,frontMatter:{title:"Complex Crowdsale",description:"Holding A Crowdsale",keywords:["sbit","ico","smart contract","token"],sidebar_position:5},sidebar:"tutorialSidebar",previous:{title:"Simple Crowdsale",permalink:"/sbit.dev/docs/Smart-Contract/SRC20/Simple-Crowdsale"},next:{title:"Inspect Raw Transaction",permalink:"/sbit.dev/docs/Smart-Contract/Blockchain-API/inspect-raw-tx"}},c={},p=[{value:"TL;DR",id:"tldr",level:2},{value:"The ICO Design",id:"the-ico-design",level:2},{value:"Supply, Allocation, And Pricing",id:"supply-allocation-and-pricing",level:2},{value:"Running The Code",id:"running-the-code",level:2},{value:"Running SBITD",id:"running-sbitd",level:2},{value:"Deploy Library",id:"deploy-library",level:2},{value:"Deploy The Crowdsale Contracts",id:"deploy-the-crowdsale-contracts",level:2},{value:"The SRC20 Token",id:"the-src20-token",level:2},{value:"Pricing Strategy",id:"pricing-strategy",level:2},{value:"Crowdsale Contract",id:"crowdsale-contract",level:2},{value:"Finalize Agent",id:"finalize-agent",level:2},{value:"Sanity Check",id:"sanity-check",level:2},{value:"Crowdsale Setup",id:"crowdsale-setup",level:2},{value:"Presale Pre-Allocation",id:"presale-pre-allocation",level:2},{value:"Public Investment",id:"public-investment",level:2},{value:"The Default Payment Method",id:"the-default-payment-method",level:2},{value:"Ending The Crowdsale",id:"ending-the-crowdsale",level:2},{value:"Ending Early",id:"ending-early",level:2},{value:"Success: Finalize The Crowdsale",id:"success-finalize-the-crowdsale",level:2},{value:"Testing Token Transfer",id:"testing-token-transfer",level:3},{value:"Failure: Refund The Crowdsale",id:"failure-refund-the-crowdsale",level:2},{value:"Owner Loading Refund",id:"owner-loading-refund",level:3},{value:"Investor Claiming Fund",id:"investor-claiming-fund",level:3}],u={toc:p};function m(e){var t=e.components,n=(0,l.Z)(e,r);return(0,o.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"In this chapter, we'll hold a crowdsale for an SRC20 token. We will use the crowdsale contracts developed by ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/TokenMarketNet/ico"},"TokenMarketNet"),". These contracts are significantly more complex than the toy examples we have seen up to now."),(0,o.kt)("p",null,"There are six different roles involved in this setup."),(0,o.kt)("p",null,"The human roles:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The owner of the crowdsale."),(0,o.kt)("li",{parentName:"ul"},"Presale investors."),(0,o.kt)("li",{parentName:"ul"},"ICO Investors.")),(0,o.kt)("p",null,"The smart contract roles:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The token minter."),(0,o.kt)("li",{parentName:"ul"},"The token's release agent."),(0,o.kt)("li",{parentName:"ul"},"The crowdsale finalizing agent.")),(0,o.kt)("p",null,"The full example can be found in the repo ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/SBit-Project/sbitjs-crowdsale-cli"},"SBit-Project/sbitjs-crowdsale-cli"),"."),(0,o.kt)("h2",{id:"tldr"},"TL;DR"),(0,o.kt)("p",null,"An outline of the crowdsale process:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"#the-ico-design"},"Design the crowdsale and token allocation"),"."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"#deploy-library"},"Deploy the SafeMathLib library"),"."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"#deploy-the-crowdsale-contracts"},"Deploy the contracts"),"."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"#crowdsale-setup"},"Configure the contracts"),"."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"#presale-pre-allocation"},"Preallocate tokens for pre-sale"),"."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"#public-investment"},"Allow the public to invest"),"."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"#ending-the-crowdsale"},"Ending the crowdsale"),".",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#success-finalize-the-crowdsale"},"If successful, finalize"),"."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#failure-refund-the-crowdsale"},"If failed, refund"),".")))),(0,o.kt)("p",null,"For a quick overview of the all the commands run for the whole crowdsale process, look at ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/SBit-Project/sbitjs-crowdsale-cli/blob/master/recipe.sh"},"recipe.sh"),"."),(0,o.kt)("p",null,"The NodeJS script that interacts with the crowdsale is ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/SBit-Project/sbitjs-crowdsale-cli/blob/master/index.js"},"index.js"),"."),(0,o.kt)("p",null,"An sample of the deployment data of the contracts involved: ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/SBit-Project/sbitjs-crowdsale-cli/blob/master/solar.development.json.example"},"solar.development.json"),"."),(0,o.kt)("h2",{id:"the-ico-design"},"The ICO Design"),(0,o.kt)("p",null,"The TokenMarketNet contracts cover many common scenarios for ICOs, providing support for different types of tokens, different caps, and different pricing strategies."),(0,o.kt)("p",null,"Our crowdsale will have the following configuration:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"BurnableCrowdsaleToken")),(0,o.kt)("p",null,"This is essentially a mintable token. It also provides the option to burn tokens, for example if you'd like to lower the percentage of tokens the team holds if the crowdsale did not reach the maximum sales goal."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"FlatPricing")),(0,o.kt)("p",null,"Everyone that participates in the public sale gets the same price. There are other pricing strategies like ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/TokenMarketNet/ico/blob/master/contracts/TokenTranchePricing.sol"},"TokenTranchePricing")," or ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/TokenMarketNet/ico/blob/master/contracts/MilestonePricing.sol"},"MilestonePricing"),"."),(0,o.kt)("p",null,"The prices are specified in satoshi (10^-8) per token."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"MintedTokenCappedCrowdsale")),(0,o.kt)("p",null,"This is a crowdsale capped by number of tokens sold."),(0,o.kt)("h2",{id:"supply-allocation-and-pricing"},"Supply, Allocation, And Pricing"),(0,o.kt)("p",null,"Let's now determine the parameters for this crowdsale. For simplicity, we'll assume that sbit's price is $100 USD."),(0,o.kt)("p",null,"The name:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Token name: MyToken"),(0,o.kt)("li",{parentName:"ul"},"Token symbol: MTK"),(0,o.kt)("li",{parentName:"ul"},"Decimals: 0 (for indivisible tokens. See: ",(0,o.kt)("a",{parentName:"li",href:"https://medium.com/@jgm.orinoco/understanding-erc-20-token-contracts-a809a7310aa5"},"Understanding SRC20"),").")),(0,o.kt)("p",null,"The supply allocation is as follows:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Total Supply: 100,000,000 MTK"),(0,o.kt)("li",{parentName:"ul"},"Team: 10%"),(0,o.kt)("li",{parentName:"ul"},"Foundation: 20%"),(0,o.kt)("li",{parentName:"ul"},"Presale: 10%, at 50% discount"),(0,o.kt)("li",{parentName:"ul"},"Public ICO: 60%")),(0,o.kt)("p",null,"The prices are:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Presale",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Price: 50000 SBIT Satoshi ($0.05 in fiat)"),(0,o.kt)("li",{parentName:"ul"},"Presale tokens: 10,000,000"),(0,o.kt)("li",{parentName:"ul"},"2000 MTK : 1 SBIT"),(0,o.kt)("li",{parentName:"ul"},"Presale amount: 5000 SBIT ($500,000)"))),(0,o.kt)("li",{parentName:"ul"},"Public ICO",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Price: 100000 SBIT Satoshi ($0.1 in fiat)"),(0,o.kt)("li",{parentName:"ul"},"ICO tokens: 60,000,000"),(0,o.kt)("li",{parentName:"ul"},"1000 MTK : 1 SBIT"),(0,o.kt)("li",{parentName:"ul"},"ICO funding: 60000 SBIT ($6,000,000)")))),(0,o.kt)("p",null,"The valuation of the token is 10M post ICO."),(0,o.kt)("h2",{id:"running-the-code"},"Running The Code"),(0,o.kt)("p",null,"Clone contracts:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"git clone --recursive \\\n  https://github.com/SBit-Project/sbitjs-crowdsale-cli\n")),(0,o.kt)("h2",{id:"running-sbitd"},"Running SBITD"),(0,o.kt)("p",null,"Run sbitd in regtest mode:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"docker run -it --rm \\\n  --name myico \\\n  -v `pwd`:/dapp \\\n  -p 22002:22002 \\\n  -p 9899:9899 \\\n  -p 9888:9888 \\\n  sbitproject/sbitportal\n")),(0,o.kt)("p",null,"Then generate some initial blocks:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"docker exec -it myico sh\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"scli generate 600\n")),(0,o.kt)("h1",{id:"configure-the-ico-owner-address"},"Configure The ICO Owner Address"),(0,o.kt)("p",null,'We\'ll need to create an address that "owns" all the contracts related to this ICO.'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"scli getnewaddress\nsf292iYbjJ41oMoArA3PrHpxTdAHuQsuAu\n\nscli gethexaddress sf292iYbjJ41oMoArA3PrHpxTdAHuQsuAu\neb6a149ec16aaaa6e47b6c0048520f7d9563b20a\n")),(0,o.kt)("p",null,"Prefund it with 100 UTXOs:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"solar prefund sf292iYbjJ41oMoArA3PrHpxTdAHuQsuAu 0.1 100\n")),(0,o.kt)("p",null,"Then we need to configure ",(0,o.kt)("inlineCode",{parentName:"p"},"solar")," to use this address when creating contracts (otherwise a random UTXO would be selected as the owner). In the container shell, set the ",(0,o.kt)("inlineCode",{parentName:"p"},"SBIT_SENDER")," environment variable:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"export SBIT_SENDER=sf292iYbjJ41oMoArA3PrHpxTdAHuQsuAu\n")),(0,o.kt)("p",null,"We will also use the owner address to receive the crowdsale investment."),(0,o.kt)("h2",{id:"deploy-library"},"Deploy Library"),(0,o.kt)("p",null,"The crowdsale contracts rely on the ",(0,o.kt)("inlineCode",{parentName:"p"},"SafeMathLib")," library for arithemetics, so that integer overflows would raise errors."),(0,o.kt)("p",null,"Use the ",(0,o.kt)("inlineCode",{parentName:"p"},"lib")," option to deploy a contract as library:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"solar deploy contracts/SafeMathLib.sol --lib\n\n\ud83d\ude80  All contracts confirmed\n   deployed contracts/SafeMathLib.sol => 26fe40c433b4d109299660284eaa475b95462342\n")),(0,o.kt)("p",null,"Once deployed, other contracts that reference the ",(0,o.kt)("inlineCode",{parentName:"p"},"SafeMathLib")," library are automatically linked to the library instance deployed at the address ",(0,o.kt)("inlineCode",{parentName:"p"},"26fe40c433b4d109299660284eaa475b95462342"),"."),(0,o.kt)("h2",{id:"deploy-the-crowdsale-contracts"},"Deploy The Crowdsale Contracts"),(0,o.kt)("p",null,"There are four contracts to deploy."),(0,o.kt)("h2",{id:"the-src20-token"},"The SRC20 Token"),(0,o.kt)("p",null,"The constructor for the SRC20 token:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"BurnableCrowdsaleToken(\n  string _name,\n  string _symbol,\n  uint _initialSupply,\n  uint _decimals,\n  bool _mintable)\n")),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/TokenMarketNet/ico/blob/master/contracts/BurnableCrowdsaleToken.sol#L18"},"https://github.com/TokenMarketNet/ico/blob/master/contracts/BurnableCrowdsaleToken.sol#L18")),(0,o.kt)("p",null,"Per the supply allocation plan, we allocate 10% to team and 20% to foundation, for a total of 30,000,000 tokens."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'solar deploy contracts/BurnableCrowdsaleToken.sol:MyToken \'\n[\n  "MyToken",\n  "MTK",\n  30000000,\n  0,\n  true\n]\n\'\n\n\ud83d\ude80  All contracts confirmed\n   deployed MyToken => 92105c87931dea43d9901bd944a48d3b8a0268ad\n')),(0,o.kt)("p",null,"The initial supply is set to 30M, with the tokens assigned to the contract owner. These tokens may later be transferred to the foundation and team vesting vault as necessary."),(0,o.kt)("h2",{id:"pricing-strategy"},"Pricing Strategy"),(0,o.kt)("p",null,"The constructor for the ",(0,o.kt)("inlineCode",{parentName:"p"},"FlatPricing")," strategy is straightforward:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"function FlatPricing(uint _oneTokenInWei)\n")),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/TokenMarketNet/ico/blob/f5b3ac6b5773f707943289b6ab1914a6b4e30683/contracts/FlatPricing.sol#L22"},"https://github.com/TokenMarketNet/ico/blob/f5b3ac6b5773f707943289b6ab1914a6b4e30683/contracts/FlatPricing.sol#L22")),(0,o.kt)("p",null,"Note that this contract was written for Ethereum, whose smallest unit is ",(0,o.kt)("inlineCode",{parentName:"p"},"wei")," (10^-9). However, SBIT inherits its ledger from Bitcoin, whose smallest unit is ",(0,o.kt)("inlineCode",{parentName:"p"},"satoshi")," (10^-8)."),(0,o.kt)("p",null,"So even though the constructor parameter name is ",(0,o.kt)("inlineCode",{parentName:"p"},"_oneTokenInWei"),", what it really means is ",(0,o.kt)("inlineCode",{parentName:"p"},"_oneTokenInSatoshi"),"."),(0,o.kt)("p",null,"The price for the public ICO is 100000 sbit satoshi (1000 MTK : 1 sbit)."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"solar deploy contracts/FlatPricing.sol '\n[\n  100000\n]\n'\n")),(0,o.kt)("h2",{id:"crowdsale-contract"},"Crowdsale Contract"),(0,o.kt)("p",null,"The crowdsale contract has a more complicated constructor:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"function MintedTokenCappedCrowdsale(\n  address _token,\n  PricingStrategy _pricingStrategy,\n  address _multisigWallet,\n  uint _start,\n  uint _end,\n  uint _minimumFundingGoal,\n  uint _maximumSellableTokens)\n  Crowdsale(\n    _token, _pricingStrategy, _multisigWallet,\n    _start, _end, _minimumFundingGoal) {\n    maximumSellableTokens = _maximumSellableTokens;\n}\n")),(0,o.kt)("p",null,"We'll need the start and end time, in ",(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Unix_time"},"unix time"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"> new Date('2018-01-15T00:00:00Z') / 1000\n1515974400\n> new Date('2018-03-01T00:00:00Z') / 1000\n1519862400\n")),(0,o.kt)("p",null,"The deploy command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"solar deploy contracts/MintedTokenCappedCrowdsale.sol:Crowdsale '\n[\n  ${MyToken},\n  ${contracts/FlatPricing.sol},\n  \"0xeb6a149ec16aaaa6e47b6c0048520f7d9563b20a\",\n  1515974400,\n  1519862400,\n  1200000000000,\n  60000000\n]\n'\n")),(0,o.kt)("p",null,"The constructor parameters are described below:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"_token"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Use ",(0,o.kt)("inlineCode",{parentName:"li"},"${MyToken}")," to interpolate the address of the ",(0,o.kt)("inlineCode",{parentName:"li"},"MyToken")," contract."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"_pricingStrategy"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Use ",(0,o.kt)("inlineCode",{parentName:"li"},"${contracts/FlatPricing.sol}")," to interpolate the address of pricing strategy."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"_multisigWallet"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"0xeb6a149ec16aaaa6e47b6c0048520f7d9563b20a"),", the owner address."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"_minimumFundingGoal"),", specified in satoshi.",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Let's set it to 20% of the funding cap."),(0,o.kt)("li",{parentName:"ul"},"60000 sbit ",(0,o.kt)("em",{parentName:"li"}," 20% == 12000 sbit == 12000 ")," 10^8 satoshi == 1200000000000 satoshi"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"_maximumSellableTokens"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"60,000,000 tokens")))),(0,o.kt)("h2",{id:"finalize-agent"},"Finalize Agent"),(0,o.kt)("p",null,"The finalize agent is a way to specify a callback that should execute when the crowdsale is successful. The least it needs to do is to release the tokens so holders are free to transfer tokens."),(0,o.kt)("p",null,"In this example we use the ",(0,o.kt)("inlineCode",{parentName:"p"},"DefaultFinalizeAgent"),", which releases the token, and does nothing else:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"function DefaultFinalizeAgent(\n  ReleasableToken _token,\n  Crowdsale _crowdsale\n)\n")),(0,o.kt)("p",null,"To deploy it:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"solar deploy contracts/DefaultFinalizeAgent.sol:FinalizeAgent '\n[\n  ${MyToken},\n  ${Crowdsale}\n]\n'\n")),(0,o.kt)("h2",{id:"sanity-check"},"Sanity Check"),(0,o.kt)("p",null,"You should now have four contracts deployed:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"solar status\n\n\u2705  MyToken\n        txid: b11f5def8559a5c351a153f8f3b8eead23fb73bfc218fe951ac7de3205205972\n     address: 92105c87931dea43d9901bd944a48d3b8a0268ad\n   confirmed: true\n       owner: qf292iYbjJ41oMoArA3PrHpxTdAHuQsuAu\n\n\u2705  contracts/FlatPricing.sol\n        txid: 2c327ebcbda2fae979b9d1c0a99973535c22bdec2bb9c96d80dea57b10c9b8ea\n     address: 8f52355c4de8dc1d3104b3773aa8c3ca31f890d1\n   confirmed: true\n       owner: qf292iYbjJ41oMoArA3PrHpxTdAHuQsuAu\n\n\u2705  FinalizeAgent\n        txid: 4d56e06efe5ef4b124421cbc1bc6ff399e1fbce9175b58221f802bf12742835d\n     address: c1ac5d69763da27e9c8fe319427c80a167298a6d\n   confirmed: true\n       owner: qf292iYbjJ41oMoArA3PrHpxTdAHuQsuAu\n\n\u2705  Crowdsale\n        txid: c99daf64a18fac29f006d88644e3e7d3c9abc8950d23f5f467b18a7da1766d26\n     address: f96403c9431ed464dd0063d18756718ac78f1edb\n   confirmed: true\n       owner: qf292iYbjJ41oMoArA3PrHpxTdAHuQsuAu\n")),(0,o.kt)("p",null,"Make sure that all of them share the same owner. If not, make sure that the environment variable ",(0,o.kt)("inlineCode",{parentName:"p"},"SBIT_SENDER")," is set to the owner address, and try again."),(0,o.kt)("p",null,"You may query for the basic information about these contracts using sbitjs:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'console.log("token supply:", await mytoken.return("totalSupply"))\nconsole.log("crowdsale state:", await crowdsale.returnAs(stateName, "getState"))\nconsole.log("crowdsale start date:", await crowdsale.returnDate("startsAt"))\nconsole.log("crowdsale end date:", await crowdsale.returnDate("endsAt"))\n\nconsole.log("investor count:", await crowdsale.return("investorCount"))\nconsole.log("sbit raised:", await crowdsale.returnCurrency("sbit", "weiRaised"))\nconsole.log("tokens sold:", await crowdsale.return("tokensSold"))\n')),(0,o.kt)("p",null,"Run the CLI script to print the info:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"node index.js info\n\ntoken supply: 30000000\ncrowdsale state: Preparing\ncrowdsale start date: 2018-01-15T00:00:00.000Z\ncrowdsale end date: 2018-03-01T00:00:00.000Z\ninvestor count: 0\nsbit raised: 0\ntokens sold: 0\n")),(0,o.kt)("p",null,"Note that the state is in ",(0,o.kt)("inlineCode",{parentName:"p"},"Preparing"),", not quite ready for action."),(0,o.kt)("h2",{id:"crowdsale-setup"},"Crowdsale Setup"),(0,o.kt)("p",null,"There is just a bit more setup, to grant permissions to different contracts to do their jobs."),(0,o.kt)("p",null,"The setup script:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'async function setupCrowdsale() {\n  // Set the finalize agent as token\'s release agent\n  if (await mytoken.return("releaseAgent") !== finalizeAgent.address) {\n    let tx = await mytoken.send("setReleaseAgent", [finalizeAgent.address])\n    console.log("confirming mytoken.setReleaseAgent:", tx.txid)\n    let receipt = await tx.confirm(1)\n    console.log("mytoken.setReleaseAgent receipt", receipt)\n  }\n  console.log("releaseAgent coinfigured")\n\n  // Set crowdsale\'s finalize agent\n  if (await crowdsale.return("finalizeAgent") !== finalizeAgent.address) {\n    tx = await crowdsale.send("setFinalizeAgent", [finalizeAgent.address])\n    console.log("confirming crowdsale.setFinalizeAgent:", tx.txid)\n    receipt = await tx.confirm(1)\n    console.log("crowdsale.setFinalizeAgent receipt", receipt)\n  }\n  console.log("finalizeAgent coinfigured")\n\n  // The mint agent of the token should be the crowdsale contract.\n  // `true` means this address is allow to mint. `false` to disable a mint agent.\n  if (await mytoken.return("mintAgents", [crowdsale.address]) !== true) {\n    tx = await mytoken.send("setMintAgent", [crowdsale.address, true])\n    console.log("confirming mytoken.setMintAgent:", tx.txid)\n    receipt = await tx.confirm(1)\n    console.log("mytoken.setMintAgent receipt", receipt)\n  }\n  console.log("mintAgents coinfigured")\n}\n')),(0,o.kt)("p",null,"Run the script with node:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"node index.js setup\n\nreleaseAgent coinfigured\nfinalizeAgent coinfigured\nmintAgents coinfigured\n")),(0,o.kt)("p",null,"Getting the info again, you should see that the crowdsale state have transitioned to ",(0,o.kt)("inlineCode",{parentName:"p"},"PreFunding"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"node index.js info\n\ntoken supply: 30000000\ncrowdsale state: PreFunding\ncrowdsale start date: 2018-01-15T00:00:00.000Z\ncrowdsale end date: 2018-03-01T00:00:00.000Z\ninvestor count: 0\nsbit raised: 0\ntokens sold: 0\n")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"The info shows the state as ",(0,o.kt)("inlineCode",{parentName:"p"},"PreFunding")," even if the current time had past the start date. The actual state should be ",(0,o.kt)("inlineCode",{parentName:"p"},"Funding"),". We'll fix this in the future")),(0,o.kt)("h2",{id:"presale-pre-allocation"},"Presale Pre-Allocation"),(0,o.kt)("p",null,"According to our ICO plan, we have already sold 10% of the token supply (10,000,000) to early investors. We'd like to record their investments on the ledger."),(0,o.kt)("p",null,"We assume that there are two investors, who invested at the same price:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'- address: "77913e470293e72c1e93ed8dda8c1372dfc0274f"\n  tokens: 6000000\n  price: 50000\n\n- address: "78d55bb60f8c0e80fda479b02e40407ee0a88ab1"\n  tokens: 4000000\n  price: 50000\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/TokenMarketNet/ico/blob/2835f331fd9a9356131dfcf0ddd2cee471b9e32f/contracts/Crowdsale.sol#L65"},"preallocate")," method allows the crowdsale owner to assign tokens to investor addresses. It is assumed that the investment money had already been transfered to the owner privately."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"function preallocate(\n  address receiver,\n  uint fullTokens,\n  uint weiPrice\n) public onlyOwner;\n")),(0,o.kt)("p",null,"To invoke ",(0,o.kt)("inlineCode",{parentName:"p"},"preallocate")," with sbitjs:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'async function preallocate(receiverAddress, tokens, price) {\n  const tx = await crowdsale.send("preallocate", [receiverAddress, tokens, price])\n  console.log("preallocate txid", tx.txid)\n\n  const receipt = await tx.confirm(1)\n  console.log("preallocate receipt:")\n\n  console.log(JSON.stringify(receipt, null, 2))\n}\n')),(0,o.kt)("p",null,"Let's use the CLI script to allocate tokens to the first investor:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"node index.js preallocate \\\n  77913e470293e72c1e93ed8dda8c1372dfc0274f \\\n  6000000 \\\n  50000\n")),(0,o.kt)("p",null,"After the transaction confirms, you should see that the events ",(0,o.kt)("inlineCode",{parentName:"p"},"Transfer")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"Invested")," are generated:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'"logs": [\n  {\n    "value": "5b8d80",\n    "from": "0000000000000000000000000000000000000000",\n    "to": "77913e470293e72c1e93ed8dda8c1372dfc0274f",\n    "type": "Transfer"\n  },\n  {\n    "investor": "77913e470293e72c1e93ed8dda8c1372dfc0274f",\n    "weiAmount": "45d964b800",\n    "tokenAmount": "5b8d80",\n    "customerId": "0",\n    "type": "Invested"\n  }\n]\n')),(0,o.kt)("p",null,"Check that the ledger had indeed allocated the tokens to this investor:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"node index.js investedBy \\\n  77913e470293e72c1e93ed8dda8c1372dfc0274f\n\ninvested by: 77913e470293e72c1e93ed8dda8c1372dfc0274f\namount (sbit): 3000\ntoken balance: 6000000\n")),(0,o.kt)("p",null,"We've finished allocation for one investor, let's repeat it for the second investor:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shells"},"node index.js preallocate \\\n  78d55bb60f8c0e80fda479b02e40407ee0a88ab1 \\\n  4000000 \\\n  50000\n")),(0,o.kt)("p",null,"Check the ledger:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"node index.js investedBy 78d55bb60f8c0e80fda479b02e40407ee0a88ab1\n\ninvested by: 78d55bb60f8c0e80fda479b02e40407ee0a88ab1\namount (sbit): 2000\ntoken balance: 4000000\n")),(0,o.kt)("p",null,"After preallocation, the crowdsale info should have changed accordingly:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"node index.js info\n\ntoken supply: 40000000\ncrowdsale state: PreFunding\ncrowdsale start date: 2018-01-15T00:00:00.000Z\ncrowdsale end date: 2018-03-01T00:00:00.000Z\ninvestor count: 0\nsbit raised: 5000\ntokens sold: 10000000\n")),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("blockquote",{parentName:"div"},(0,o.kt)("p",{parentName:"blockquote"},"The investor count is still 0 because the contract implementation assumes that one preallocation address may in fact distribute the tokens further to an arbitrary number of a smaller investors.")))),(0,o.kt)("h2",{id:"public-investment"},"Public Investment"),(0,o.kt)("p",null,"Once the crowdsale is in the ",(0,o.kt)("inlineCode",{parentName:"p"},"Funding")," state, public investors may start to send in money. We'll let the investors use the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/TokenMarketNet/ico/blob/2835f331fd9a9356131dfcf0ddd2cee471b9e32f/contracts/Crowdsale.sol#L104"},"invest")," method."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"The precise conditions that determines the state of the crowdsale is defined in the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/TokenMarketNet/ico/blob/2835f331fd9a9356131dfcf0ddd2cee471b9e32f/contracts/CrowdsaleBase.sol#L361"},"getState")," method.")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"invest")," method sends in an amount of sbit, and receive a corresponding amount of tokens as determined by the pricing strategy. This method is more expensive to compute, so we set a higher gas limit of 300,000:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'async function invest(address, amount) {\n  console.log("invest", address, amount)\n  const tx = await crowdsale.send("invest", [address], {\n    amount,\n    gasLimit: 300000,\n  })\n  console.log("invest txid", tx.txid)\n  const receipt = await tx.confirm(1)\n  console.log("invest receipt:")\n  console.log(JSON.stringify(receipt, null, 2))\n}\n')),(0,o.kt)("p",null,"Invoke the CLI tool to invest 7000 SBITs:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"node index.js invest \\\n  6607919dd81d8e958b31e2ef089139505faada4d \\\n  7000\n")),(0,o.kt)("p",null,"After confirmation, we should see that this address had received 3000 MTKs:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"node index.js investedBy 6607919dd81d8e958b31e2ef089139505faada4d\n\ninvested by: 6607919dd81d8e958b31e2ef089139505faada4d\namount (sbit): 7000\ntoken balance: 7000000\n")),(0,o.kt)("p",null,"And the crowdsale info should have updated as well:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"node index.js info\n\ninvestor count: 1\nsbit raised: 12000\ntokens sold: 17000000\nminimum funding goal: 12000\nminimum funding goal reached: true\n")),(0,o.kt)("p",null,"This single investor had helped us reach the funding goal!"),(0,o.kt)("h2",{id:"the-default-payment-method"},"The Default Payment Method"),(0,o.kt)("p",null,"By default an investor is not allowed to invest by sending money to this contract directly. The default action is to throw:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"/**\n  * Don't expect to just send in money and get tokens.\n  */\nfunction() payable {\n  throw;\n}\n")),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"If this is a desired behaviour, you could override the default method in your on subclass of the ",(0,o.kt)("inlineCode",{parentName:"p"},"Crowdsale")," contract."))),(0,o.kt)("h2",{id:"ending-the-crowdsale"},"Ending The Crowdsale"),(0,o.kt)("p",null,"There are two ways to end a crowdsale once the end date is reached, depending on whether the sale was successful."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"If the minimum funding goal was reached, finalize the crowdsale, so investors can start to transfer and trade the tokens."),(0,o.kt)("li",{parentName:"ol"},"If the minimum funding goal was not reached, refund each investor the amount they sent.")),(0,o.kt)("h2",{id:"ending-early"},"Ending Early"),(0,o.kt)("p",null,"We can set the ",(0,o.kt)("inlineCode",{parentName:"p"},"endsAt")," property of the contract to either extend the deadline or to end the crowdsale early."),(0,o.kt)("p",null,"For our example, we'll end the crowdsale early. Invoke the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/TokenMarketNet/ico/blob/2835f331fd9a9356131dfcf0ddd2cee471b9e32f/contracts/CrowdsaleBase.sol#L265"},"setEndsAt")," method to end the crowdsale 60 seconds from now:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'async function endCrowdsaleNow() {\n  const nowDate = new Date()\n  // You may need to choose a larger delay than 60s on a\n  // real network, where there may be a larger clock skew.\n  const now = Math.floor(nowDate / 1000) + 60\n  const tx = await crowdsale.send("setEndsAt", [now])\n  const receipt = await tx.confirm(1)\n  console.log("end now receipt:")\n  console.log(JSON.stringify(receipt, null, 2))\n}\n')),(0,o.kt)("p",null,"Run the CLI script:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"node index.js endnow\n")),(0,o.kt)("p",null,"The expected output:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "blockHash": "66f22e1eb5baa344393de75b8133fadd81aa06b9697ef89eb5fcc5d4f1146507",\n  "blockNumber": 6351,\n  "transactionHash": "ea267d815839a89db017b8c9f83dfa7c15d9b83cff3893c6ca1831e0525dd975",\n  "transactionIndex": 1,\n  "from": "eb6a149ec16aaaa6e47b6c0048520f7d9563b20a",\n  "to": "d7329343d159af9b628212e4ec6986d54882b3f3",\n  "cumulativeGasUsed": 29025,\n  "gasUsed": 29025,\n  "contractAddress": "d7329343d159af9b628212e4ec6986d54882b3f3",\n  "logs": [\n    {\n      "newEndsAt": "5a7c063b",\n      "type": "EndsAtChanged"\n    }\n  ],\n  "rawlogs": [\n    {\n      "address": "d7329343d159af9b628212e4ec6986d54882b3f3",\n      "topics": [\n        "d34bb772c4ae9baa99db852f622773b31c7827e8ee818449fef20d30980bd310"\n      ],\n      "data": "000000000000000000000000000000000000000000000000000000005a7c063b"\n    }\n  ]\n}\n')),(0,o.kt)("h2",{id:"success-finalize-the-crowdsale"},"Success: Finalize The Crowdsale"),(0,o.kt)("p",null,"Suppose the funding goal was reached, invoking ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/TokenMarketNet/ico/blob/2835f331fd9a9356131dfcf0ddd2cee471b9e32f/contracts/CrowdsaleBase.sol#L226"},"finalize")," will release the token for transferring."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'async function finalize() {\n  const finalized = await crowdsale.return("finalized")\n\n  if (finalized) {\n    throw new Error("crowdsale is already finalized")\n  }\n\n  const tx = await crowdsale.send("finalize")\n  const receipt = await tx.confirm(1)\n  console.log("finalize receipt:", receipt)\n}\n')),(0,o.kt)("p",null,"Run the CLI script:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"node index.js finalize\n")),(0,o.kt)("p",null,"The output:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"finalize receipt:\n\n{ blockHash: '1bb4bce0b258eb5cb7fa99cc59d1c3e8eca7fabdba98bf1ddcf329ba35943f00',\n  blockNumber: 6468,\n  transactionHash: '460942ae789a0c86674663fe9740bfbe5db843efec64a8074d35bcba31eb7d7c',\n  transactionIndex: 1,\n  from: 'eb6a149ec16aaaa6e47b6c0048520f7d9563b20a',\n  to: '004fece7860cfa26a5be3009020430440e4784a4',\n  cumulativeGasUsed: 83254,\n  gasUsed: 83254,\n  contractAddress: '004fece7860cfa26a5be3009020430440e4784a4',\n  logs: [],\n  rawlogs: [] }\n")),(0,o.kt)("h3",{id:"testing-token-transfer"},"Testing Token Transfer"),(0,o.kt)("p",null,"After finalizing, the tokens should become transferrable. Let's generate a new address and try to send it some tokens:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"scli getnewaddress\nsdobbjdAGJmi4Syu7EjDN7XcdE8nFpbgCm\n\nscli gethexaddress sdobbjdAGJmi4Syu7EjDN7XcdE8nFpbgCm\nde12b9e72a21394a405ce1830e223beaf2dc1a40\n")),(0,o.kt)("p",null,"One of the investor should have 7000000 tokens from the ICO:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"node index.js balanceOf 6607919dd81d8e958b31e2ef089139505faada4d\n\nbalance: 7000000\n")),(0,o.kt)("p",null,"We need to prefund the sender address with UTXOs to pay for transactions:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"$ scli fromhexaddress 6607919dd81d8e958b31e2ef089139505faada4d\nsSrs9VHVveZpiYojiaZc8VAz8JJFDu9y7o\n\n$ solar prefund sSrs9VHVveZpiYojiaZc8VAz8JJFDu9y7o 0.1 100\n")),(0,o.kt)("p",null,"Now, transfer 1000 tokens to the address ",(0,o.kt)("inlineCode",{parentName:"p"},"de12b9e72a21394a405ce1830e223beaf2dc1a40"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"node index.js transfer \\\n  sSrs9VHVveZpiYojiaZc8VAz8JJFDu9y7o \\\n  de12b9e72a21394a405ce1830e223beaf2dc1a40 \\\n  1000\n")),(0,o.kt)("p",null,"After confirmation, the balance of the receiving address should be 1000:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"node index.js balanceOf \\\n  de12b9e72a21394a405ce1830e223beaf2dc1a40\n")),(0,o.kt)("p",null,"And the balance of the original sender should have decremented by 1000:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"node index.js balanceOf \\\n  6607919dd81d8e958b31e2ef089139505faada4d\nbalance: 6999000\n")),(0,o.kt)("p",null,"Congrats, you have completed a successful crowdsale!"),(0,o.kt)("h2",{id:"failure-refund-the-crowdsale"},"Failure: Refund The Crowdsale"),(0,o.kt)("p",null,"Suppose the crowdsale ended but the minimum funding goal was not reached:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"node index.js info\ntoken supply: 37000000\ncrowdsale state: PreFunding\ncrowdsale start date: 2018-01-15T00:00:00.000Z\ncrowdsale end date: 2018-02-08T09:43:00.000Z\ninvestor count: 1\nsbit raised: 7000\ntokens sold: 7000000\nminimum funding goal: 12000\nminimum funding goal reached: false\n")),(0,o.kt)("p",null,"We could extend the end date to give investors more time. But in this demostration we'll just refund everyone."),(0,o.kt)("p",null,"To initiate the refund process:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"The crowdsale owner invokes ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/TokenMarketNet/ico/blob/2835f331fd9a9356131dfcf0ddd2cee471b9e32f/contracts/CrowdsaleBase.sol#L315"},"loadRefund")," to fund the contract with the total amount raised so far."),(0,o.kt)("li",{parentName:"ol"},"Individual investor invoke ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/TokenMarketNet/ico/blob/2835f331fd9a9356131dfcf0ddd2cee471b9e32f/contracts/CrowdsaleBase.sol#L326"},"refund")," to claim the fund.")),(0,o.kt)("h3",{id:"owner-loading-refund"},"Owner Loading Refund"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'async function loadRefund() {\n  const amountRaised = await crowdsale.returnCurrency("sbit", "weiRaised")\n\n  const loadedRefund = await crowdsale.returnCurrency("sbit", "loadedRefund")\n\n  const amountToLoad = amountRaised - loadedRefund\n\n  console.log("amount to load as refund", amountToLoad)\n\n  if (amountToLoad > 0) {\n    const tx = await crowdsale.send("loadRefund", [], {\n      amount: amountToLoad,\n    })\n    console.log("tx:", tx)\n    const receipt = await tx.confirm(1)\n    console.log("receipt", receipt)\n  }\n}\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"node index.js loadRefund\n")),(0,o.kt)("h3",{id:"investor-claiming-fund"},"Investor Claiming Fund"),(0,o.kt)("p",null,"The amount invested by ",(0,o.kt)("inlineCode",{parentName:"p"},"6607919dd81d8e958b31e2ef089139505faada4d")," should be 7000 sbit:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"node index.js investedBy \\\n 6607919dd81d8e958b31e2ef089139505faada4d\n\ninvested by: 6607919dd81d8e958b31e2ef089139505faada4d\namount (sbit): 7000\ntoken balance: 7000000\n")),(0,o.kt)("p",null,"The investory can invoke ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/TokenMarketNet/ico/blob/2835f331fd9a9356131dfcf0ddd2cee471b9e32f/contracts/CrowdsaleBase.sol#L326"},"refund")," like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'async function refund(addr) {\n  const tx = await crowdsale.send("refund", [], {\n    senderAddress: addr,\n  })\n  const receipt = await tx.confirm(1)\n  console.log("receipt", receipt)\n}\n')),(0,o.kt)("p",null,"Running the CLI:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"node index.js refund \\\n  sSrs9VHVveZpiYojiaZc8VAz8JJFDu9y7o\n\n{ blockHash: '09ea6c4cdf9e0007d21d43f9a3f6fe9fd124621118d8384bb9c6575a04320faa',\n  blockNumber: 6641,\n  transactionHash: '11290f6e8809a94273d12fe202c5f2898e14be3f51edf81c43b73bf4259c412d',\n  transactionIndex: 1,\n  from: '6607919dd81d8e958b31e2ef089139505faada4d',\n  to: '8a4e597e966b9c8886c006ce84168b9fc6734c22',\n  cumulativeGasUsed: 53815,\n  gasUsed: 53815,\n  contractAddress: '8a4e597e966b9c8886c006ce84168b9fc6734c22',\n  logs:\n   [ Result {\n       investor: '6607919dd81d8e958b31e2ef089139505faada4d',\n       weiAmount: <BN: a2fb405800>,\n       type: 'Refund' } ],\n  rawlogs:\n   [ { address: '8a4e597e966b9c8886c006ce84168b9fc6734c22',\n       topics: [Array],\n       data: '0000000000000000000000006607919dd81d8e958b31e2ef089139505faada4d000000000000000000000000000000000000000000000000000000a2fb405800' } ] }\n")),(0,o.kt)("p",null,"Use the ",(0,o.kt)("inlineCode",{parentName:"p"},"listunspent")," command to check if the fund had indeed been returned:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"scli listunspent 0 999990 \\\n  '[\"sSrs9VHVveZpiYojiaZc8VAz8JJFDu9y7o\"]'\n")),(0,o.kt)("p",null,"There should be an UTXO created for this address with 7000 sbit:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'[\n  // other UTXOs ...\n\n  {\n    "txid": "e0afc2742ffa636c6ff788fbb808f5b34276206d713bb25874cb0e48a0070974",\n    "vout": 0,\n    "address": "sSrs9VHVveZpiYojiaZc8VAz8JJFDu9y7o",\n    "account": "",\n    "scriptPubKey": "76a9146607919dd81d8e958b31e2ef089139505faada4d88ac",\n    "amount": 7000.00000000,\n    "confirmations": 5,\n    "spendable": true,\n    "solvable": true\n  }\n]\n')))}m.isMDXComponent=!0}}]);