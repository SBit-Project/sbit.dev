"use strict";(self.webpackChunksbit_website=self.webpackChunksbit_website||[]).push([[2345],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return h}});var i=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=i.createContext({}),p=function(e){var t=i.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=p(e.components);return i.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},c=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),c=p(n),h=a,m=c["".concat(s,".").concat(h)]||c[h]||d[h]||r;return n?i.createElement(m,l(l({ref:t},u),{},{components:n})):i.createElement(m,l({ref:t},u))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,l=new Array(r);l[0]=c;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:a,l[1]=o;for(var p=2;p<r;p++)l[p]=n[p];return i.createElement.apply(null,l)}return i.createElement.apply(null,n)}c.displayName="MDXCreateElement"},146:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return s},default:function(){return h},frontMatter:function(){return o},metadata:function(){return p},toc:function(){return d}});var i=n(7462),a=n(3366),r=(n(7294),n(3905)),l=["components"],o={title:"Gitian building",description:"Setup instructions for a Gitian build of SBit Core using a Debian VM or physical system.",keywords:["sbit","bitcoin","blockchain","ethereum"],sidebar_position:8},s=void 0,p={unversionedId:"SBit-Core/Building/gitian-building",id:"SBit-Core/Building/gitian-building",title:"Gitian building",description:"Setup instructions for a Gitian build of SBit Core using a Debian VM or physical system.",source:"@site/docs/SBit-Core/Building/gitian-building.md",sourceDirName:"SBit-Core/Building",slug:"/SBit-Core/Building/gitian-building",permalink:"/sbit.dev/docs/SBit-Core/Building/gitian-building",tags:[],version:"current",sidebarPosition:8,frontMatter:{title:"Gitian building",description:"Setup instructions for a Gitian build of SBit Core using a Debian VM or physical system.",keywords:["sbit","bitcoin","blockchain","ethereum"],sidebar_position:8},sidebar:"tutorialSidebar",previous:{title:"Building SBit Core with Visual Studio",permalink:"/sbit.dev/docs/SBit-Core/Building/build-msvc"},next:{title:"Depend",permalink:"/sbit.dev/docs/SBit-Core/Building/depend"}},u={},d=[{value:"Table of Contents",id:"table-of-contents",level:2},{value:"Preparing the Gitian builder host",id:"preparing-the-gitian-builder-host",level:2},{value:"Create a new VirtualBox VM",id:"create-a-new-virtualbox-vm",level:2},{value:"Installing Debian",id:"installing-debian",level:2},{value:"After Installation",id:"after-installation",level:2},{value:"Connecting to the VM",id:"connecting-to-the-vm",level:2},{value:"Setting up Debian for Gitian building",id:"setting-up-debian-for-gitian-building",level:2},{value:"Installing Gitian",id:"installing-gitian",level:2},{value:"Setting up the Gitian image",id:"setting-up-the-gitian-image",level:2},{value:"Getting and building the inputs",id:"getting-and-building-the-inputs",level:2},{value:"Building SBit Core",id:"building-sbit-core",level:2},{value:"Building an alternative repository",id:"building-an-alternative-repository",level:2},{value:"Building fully offline",id:"building-fully-offline",level:2},{value:"Signing externally",id:"signing-externally",level:2},{value:"Uploading signatures",id:"uploading-signatures",level:2}],c={toc:d};function h(e){var t=e.components,n=(0,a.Z)(e,l);return(0,r.kt)("wrapper",(0,i.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Setup instructions for a Gitian build of SBit Core using a Debian VM or physical system.")),(0,r.kt)("p",null,"Gitian is the deterministic build process that is used to build the SBit\nCore executables. It provides a way to be reasonably sure that the\nexecutables are really built from the source on GitHub. It also makes sure that\nthe same, tested dependencies are used and statically built into the executable."),(0,r.kt)("p",null,'Multiple developers build the source code by following a specific descriptor\n("recipe"), cryptographically sign the result, and upload the resulting signature.\nThese results are compared and only if they match, the build is accepted and uploaded\nto sbit.org.'),(0,r.kt)("p",null,"More independent Gitian builders are needed, which is why this guide exists.\nIt is preferred you follow these steps yourself instead of using someone else's\nVM image to avoid 'contaminating' the build."),(0,r.kt)("h2",{id:"table-of-contents"},"Table of Contents"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#create-a-new-virtualbox-vm"},"Create a new VirtualBox VM")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#connecting-to-the-vm"},"Connecting to the VM")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#setting-up-debian-for-gitian-building"},"Setting up Debian for Gitian building")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#installing-gitian"},"Installing Gitian")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#setting-up-the-gitian-image"},"Setting up the Gitian image")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#getting-and-building-the-inputs"},"Getting and building the inputs")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#building-sbit-core"},"Building SBit Core")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#building-an-alternative-repository"},"Building an alternative repository")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#signing-externally"},"Signing externally")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#uploading-signatures"},"Uploading signatures"))),(0,r.kt)("h2",{id:"preparing-the-gitian-builder-host"},"Preparing the Gitian builder host"),(0,r.kt)("p",null,"The first step is to prepare the host environment that will be used to perform the Gitian builds.\nThis guide explains how to set up the environment, and how to start the builds."),(0,r.kt)("p",null,"Debian Linux was chosen as the host distribution because it has a lightweight install (in contrast to Ubuntu) and is readily available.\nAny kind of virtualization can be used, for example:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.virtualbox.org/"},"VirtualBox")," (covered by this guide)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"http://www.linux-kvm.org/page/Main_Page"},"KVM")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://linuxcontainers.org/"},"LXC"))),(0,r.kt)("p",null,"You can also install Gitian on actual hardware instead of using virtualization."),(0,r.kt)("h2",{id:"create-a-new-virtualbox-vm"},"Create a new VirtualBox VM"),(0,r.kt)("p",null,'In the VirtualBox GUI click "New" and choose the following parameters in the wizard:'),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Type: Linux, Debian (64-bit)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Memory Size: at least 3000MB, anything less and the build might not complete.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Hard Disk: Create a virtual hard disk now")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Hard Disk file type: Use the default, VDI (VirtualBox Disk Image)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Storage on physical hard disk: Dynamically Allocated")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"File location and size: at least 40GB; as low as 20GB ",(0,r.kt)("em",{parentName:"p"},"may")," be possible, but better to err on the safe side")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Click ",(0,r.kt)("inlineCode",{parentName:"p"},"Create")))),(0,r.kt)("p",null,"After creating the VM, we need to configure it."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Click the ",(0,r.kt)("inlineCode",{parentName:"p"},"Settings")," button, then go to ",(0,r.kt)("inlineCode",{parentName:"p"},"System")," tab and ",(0,r.kt)("inlineCode",{parentName:"p"},"Processor")," sub-tab. Increase the number of processors to the number of cores on your machine if you want builds to be faster.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Go to the ",(0,r.kt)("inlineCode",{parentName:"p"},"Network")," tab. Adapter 1 should be attached to ",(0,r.kt)("inlineCode",{parentName:"p"},"NAT"),".")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Click ",(0,r.kt)("inlineCode",{parentName:"p"},"Advanced"),", then ",(0,r.kt)("inlineCode",{parentName:"p"},"Port Forwarding"),". We want to set up a port through which we can reach the VM to get files in and out.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Create a new rule by clicking the plus icon.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Set up the new rule the following way:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Name: ",(0,r.kt)("inlineCode",{parentName:"li"},"SSH")),(0,r.kt)("li",{parentName:"ul"},"Protocol: ",(0,r.kt)("inlineCode",{parentName:"li"},"TCP")),(0,r.kt)("li",{parentName:"ul"},"Leave Host IP empty"),(0,r.kt)("li",{parentName:"ul"},"Host Port: ",(0,r.kt)("inlineCode",{parentName:"li"},"22222")),(0,r.kt)("li",{parentName:"ul"},"Leave Guest IP empty"),(0,r.kt)("li",{parentName:"ul"},"Guest Port: ",(0,r.kt)("inlineCode",{parentName:"li"},"22")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Click ",(0,r.kt)("inlineCode",{parentName:"p"},"Ok")," twice to save."))),(0,r.kt)("p",null,"Get the ",(0,r.kt)("a",{parentName:"p",href:"http://cdimage.debian.org/mirror/cdimage/archive/8.5.0/amd64/iso-cd/debian-8.5.0-amd64-netinst.iso"},"Debian 8.x net installer")," (a more recent minor version should also work, see also ",(0,r.kt)("a",{parentName:"p",href:"https://www.debian.org/CD/netinst/"},"Debian Network installation"),").\nThis DVD image can be ",(0,r.kt)("a",{parentName:"p",href:"https://www.debian.org/CD/verify"},"validated")," using a SHA256 hashing tool, for example on\nUnixy OSes by entering the following in a terminal:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'echo "ad4e8c27c561ad8248d5ebc1d36eb172f884057bfeb2c22ead823f59fa8c3dff  debian-8.5.0-amd64-netinst.iso" | sha256sum -c\n# (must return OK)\n')),(0,r.kt)("p",null,"Then start the VM. On the first launch you will be asked for a CD or DVD image. Choose the downloaded ISO."),(0,r.kt)("h2",{id:"installing-debian"},"Installing Debian"),(0,r.kt)("p",null,"This section will explain how to install Debian on the newly created VM."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Choose the non-graphical installer.  We do not need the graphical environment; it will only increase installation time and disk usage.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Note"),": Navigating in the Debian installer:\nTo keep a setting at the default and proceed, just press ",(0,r.kt)("inlineCode",{parentName:"p"},"Enter"),".\nTo select a different button, press ",(0,r.kt)("inlineCode",{parentName:"p"},"Tab"),"."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Choose locale and keyboard settings (doesn't matter, you can just go with the defaults or select your own information)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The VM will detect network settings using DHCP, this should all proceed automatically")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Configure the network:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Hostname ",(0,r.kt)("inlineCode",{parentName:"li"},"debian"),"."),(0,r.kt)("li",{parentName:"ul"},"Leave domain name empty."))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Choose a root password and enter it twice (remember it for later)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Name the new user ",(0,r.kt)("inlineCode",{parentName:"p"},"debian")," (the full name doesn't matter, you can leave it empty)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Set the account username as ",(0,r.kt)("inlineCode",{parentName:"p"},"debian"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Choose a user password and enter it twice (remember it for later)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The installer will set up the clock using a time server; this process should be automatic")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Set up the clock: choose a time zone (depends on the locale settings that you picked earlier; specifics don't matter)  ")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Disk setup"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Partitioning method: Guided - Use the entire disk")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Select disk to partition: SCSI1 (0,0,0)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Partition Disks -> ",(0,r.kt)("em",{parentName:"p"},"All files in one partition"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Finish partitioning and write changes to disk -> ",(0,r.kt)("em",{parentName:"p"},"Yes")," (",(0,r.kt)("inlineCode",{parentName:"p"},"Tab"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Enter")," to select the ",(0,r.kt)("inlineCode",{parentName:"p"},"Yes")," button)")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The base system will be installed, this will take a minute or so")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Choose a mirror (any will do)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Enter proxy information (unless you are on an intranet, leave this empty)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Wait a bit while 'Select and install software' runs")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Participate in popularity contest -> ",(0,r.kt)("em",{parentName:"p"},"No"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Choose software to install. We need just the base system.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Make sure only 'SSH server' and 'Standard System Utilities' are checked")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Uncheck 'Debian Desktop Environment' and 'Print Server'")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Install the GRUB boot loader to the master boot record? -> Yes")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Device for boot loader installation -> ata-VBOX_HARDDISK")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Installation Complete -> ",(0,r.kt)("em",{parentName:"p"},"Continue"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"After installation, the VM will reboot and you will have a working Debian VM. Congratulations!"))),(0,r.kt)("h2",{id:"after-installation"},"After Installation"),(0,r.kt)("p",null,"The next step in the guide involves logging in as root via SSH.\nSSH login for root users is disabled by default, so we'll enable that now."),(0,r.kt)("p",null,"Login to the VM using username ",(0,r.kt)("inlineCode",{parentName:"p"},"root")," and the root password you chose earlier.\nYou'll be presented with a screen similar to this."),(0,r.kt)("p",null,"Type:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"sed -i 's/^PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config\n")),(0,r.kt)("p",null,"and press enter. Then,"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"/etc/init.d/ssh restart\n")),(0,r.kt)("p",null,"and enter to restart SSH. Logout by typing 'logout' and pressing 'enter'."),(0,r.kt)("h2",{id:"connecting-to-the-vm"},"Connecting to the VM"),(0,r.kt)("p",null,"After the VM has booted you can connect to it using SSH, and files can be copied from and to the VM using a SFTP utility.\nConnect to ",(0,r.kt)("inlineCode",{parentName:"p"},"localhost"),", port ",(0,r.kt)("inlineCode",{parentName:"p"},"22222")," (or the port configured when installing the VM).\nOn Windows you can use ",(0,r.kt)("a",{parentName:"p",href:"http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html"},"putty")," and ",(0,r.kt)("a",{parentName:"p",href:"http://winscp.net/eng/index.php"},"WinSCP"),"."),(0,r.kt)("p",null,"For example, to connect as ",(0,r.kt)("inlineCode",{parentName:"p"},"root")," from a Linux command prompt use"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"    $ ssh root@localhost -p 22222\n    The authenticity of host '[localhost]:22222 ([127.0.0.1]:22222)' can't be established.\n    RSA key fingerprint is ae:f5:c8:9f:17:c6:c7:1b:c2:1b:12:31:1d:bb:d0:c7.\n    Are you sure you want to continue connecting (yes/no)? yes\n    Warning: Permanently added '[localhost]:22222' (RSA) to the list of known hosts.\n    root@localhost's password: (enter root password configured during install)\n\n    The programs included with the Debian GNU/Linux system are free software;\n    the exact distribution terms for each program are described in the\n    individual files in /usr/share/doc/*/copyright.\n\n    Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent\n    permitted by applicable law.\n    root@debian:~#\n")),(0,r.kt)("p",null,"Replace ",(0,r.kt)("inlineCode",{parentName:"p"},"root")," with ",(0,r.kt)("inlineCode",{parentName:"p"},"debian")," to log in as user."),(0,r.kt)("h2",{id:"setting-up-debian-for-gitian-building"},"Setting up Debian for Gitian building"),(0,r.kt)("p",null,"In this section we will be setting up the Debian installation for Gitian building."),(0,r.kt)("p",null,"First we need to log in as ",(0,r.kt)("inlineCode",{parentName:"p"},"root")," to set up dependencies and make sure that our\nuser can use the sudo command. Type/paste the following in the terminal:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"apt-get install git ruby sudo apt-cacher-ng qemu-utils debootstrap lxc python-cheetah parted kpartx bridge-utils make ubuntu-archive-keyring curl\nadduser debian sudo\n")),(0,r.kt)("p",null,"Then set up LXC and the rest with the following, which is a complex jumble of settings and workarounds:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# the version of lxc-start in Debian needs to run as root, so make sure\n# that the build script can execute it without providing a password\necho \"%sudo ALL=NOPASSWD: /usr/bin/lxc-start\" > /etc/sudoers.d/gitian-lxc\necho \"%sudo ALL=NOPASSWD: /usr/bin/lxc-execute\" >> /etc/sudoers.d/gitian-lxc\n# make /etc/rc.local script that sets up bridge between guest and host\necho '#!/bin/sh -e' > /etc/rc.local\necho 'brctl addbr br0' >> /etc/rc.local\necho 'ifconfig br0 10.0.3.2/24 up' >> /etc/rc.local\necho 'iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE' >> /etc/rc.local\necho 'echo 1 > /proc/sys/net/ipv4/ip_forward' >> /etc/rc.local\necho 'exit 0' >> /etc/rc.local\n# make sure that USE_LXC is always set when logging in as debian,\n# and configure LXC IP addresses\necho 'export USE_LXC=1' >> /home/debian/.profile\necho 'export GITIAN_HOST_IP=10.0.3.2' >> /home/debian/.profile\necho 'export LXC_GUEST_IP=10.0.3.5' >> /home/debian/.profile\nreboot\n")),(0,r.kt)("p",null,"At the end the VM is rebooted to make sure that the changes take effect. The steps in this\nsection only need to be performed once."),(0,r.kt)("h2",{id:"installing-gitian"},"Installing Gitian"),(0,r.kt)("p",null,"Re-login as the user ",(0,r.kt)("inlineCode",{parentName:"p"},"debian")," that was created during installation.\nThe rest of the steps in this guide will be performed as that user."),(0,r.kt)("p",null,"There is no ",(0,r.kt)("inlineCode",{parentName:"p"},"python-vm-builder")," package in Debian, so we need to install it from source ourselves,"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'wget http://archive.ubuntu.com/ubuntu/pool/universe/v/vm-builder/vm-builder_0.12.4+bzr494.orig.tar.gz\necho "76cbf8c52c391160b2641e7120dbade5afded713afaa6032f733a261f13e6a8e  vm-builder_0.12.4+bzr494.orig.tar.gz" | sha256sum -c\n# (verification -- must return OK)\ntar -zxvf vm-builder_0.12.4+bzr494.orig.tar.gz\ncd vm-builder-0.12.4+bzr494\nsudo python setup.py install\ncd ..\n')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Note"),": When sudo asks for a password, enter the password for the user ",(0,r.kt)("em",{parentName:"p"},"debian")," not for ",(0,r.kt)("em",{parentName:"p"},"root"),"."),(0,r.kt)("p",null,"Clone the git repositories for sbit and Gitian."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/devrandom/gitian-builder.git\ngit clone https://github.com/SBit-Project/SBit --recursive\ngit clone https://github.com/SBit-Project/gitian.sigs.git\n")),(0,r.kt)("h2",{id:"setting-up-the-gitian-image"},"Setting up the Gitian image"),(0,r.kt)("p",null,"Gitian needs a virtual image of the operating system to build in.\nCurrently this is Ubuntu Trusty x86_64 for Linux and OSX, and Ubuntu Xenial x86_64 for Windows.\nThis image will be copied and used every time that a build is started to\nmake sure that the build is deterministic.\nCreating the image will take a while, but only has to be done once."),(0,r.kt)("p",null,"Execute the following as user ",(0,r.kt)("inlineCode",{parentName:"p"},"debian"),":"),(0,r.kt)("p",null,"First, we must add the xenial setup script for LXC, as this is missing in older versions of debootstrap:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo cp /home/debian/sbit/contrib/gitian-descriptors/xenial /usr/share/debootstrap/scripts\n")),(0,r.kt)("p",null,"And now with that in place, setup the VM images:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cd gitian-builder\nbin/make-base-vm --lxc --arch amd64 --suite trusty\nbin/make-base-vm --lxc --arch amd64 --suite xenial\n")),(0,r.kt)("p",null,"There will be a lot of warnings printed during the build of the 2 images. These can be ignored. The Xenial image is only used for Windows builds."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"}," When sudo asks for a password, enter the password for the user ",(0,r.kt)("em",{parentName:"p"},"debian")," not for ",(0,r.kt)("em",{parentName:"p"},"root"),"."))),(0,r.kt)("h2",{id:"getting-and-building-the-inputs"},"Getting and building the inputs"),(0,r.kt)("p",null,"At this point you have two options, you can either use the automated script (found in ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/SBit-Project/sbit/contrib/gitian-build.py"},"contrib/gitian-build.py"),') or you could manually do everything by following this guide. If you\'re using the automated script, then run it with the "--setup" command. Afterwards, run it with the "--build" command (example: "contrib/gitian-build.sh -b signer 0.13.0"). Otherwise ignore this.'),(0,r.kt)("p",null,"Follow the instructions in ",(0,r.kt)("a",{parentName:"p",href:"../Development/release-process#fetch-and-create-inputs-first-time-or-when-dependency-versions-change"},"doc/release-process.md"),"\nin the sbit repository under 'Fetch and create inputs' to install sources which require\nmanual intervention. Also optionally follow the next step: 'Seed the Gitian sources cache\nand offline git repositories' which will fetch the remaining files required for building\noffline."),(0,r.kt)("h2",{id:"building-sbit-core"},"Building SBit Core"),(0,r.kt)("p",null,"To build SBit Core (for Linux, OS X and Windows) just follow the steps under 'perform\nGitian builds' in ",(0,r.kt)("a",{parentName:"p",href:"../Development/release-process#perform-gitian-builds"},"doc/release-process.md")," in the sbit repository."),(0,r.kt)("p",null,"This may take some time as it will build all the dependencies needed for each descriptor.\nThese dependencies will be cached after a successful build to avoid rebuilding them when possible."),(0,r.kt)("p",null,"At any time you can check the package installation and build progress with"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"tail -f var/install.log\ntail -f var/build.log\n")),(0,r.kt)("p",null,"Output from ",(0,r.kt)("inlineCode",{parentName:"p"},"gbuild")," will look something like"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"Initialized empty Git repository in /home/debian/gitian-builder/inputs/sbit/.git/\nremote: Counting objects: 57959, done.\nremote: Total 57959 (delta 0), reused 0 (delta 0), pack-reused 57958\nReceiving objects: 100% (57959/57959), 53.76 MiB | 484.00 KiB/s, done.\nResolving deltas: 100% (41590/41590), done.\nFrom https://github.com/SBit-Project/SBit\n... (new tags, new branch etc)\n--- Building for trusty amd64 ---\nStopping target if it is up\nMaking a new image copy\nstdin: is not a tty\nStarting target\nChecking if target is up\nPreparing build environment\nUpdating apt-get repository (log in var/install.log)\nInstalling additional packages (log in var/install.log)\nGrabbing package manifest\nstdin: is not a tty\nCreating build script (var/build-script)\nlxc-start: Connection refused - inotify event with no name (mask 32768)\nRunning build script (log in var/build.log)\n")),(0,r.kt)("h2",{id:"building-an-alternative-repository"},"Building an alternative repository"),(0,r.kt)("p",null,"If you want to do a test build of a pull on GitHub it can be useful to point\nthe Gitian builder at an alternative repository, using the same descriptors\nand inputs."),(0,r.kt)("p",null,"For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"URL=https://github.com/laanwj/sbit.git\nCOMMIT=2014_03_windows_unicode_path\n./bin/gbuild --commit sbit=${COMMIT} --url sbit=${URL} ../sbit/contrib/gitian-descriptors/gitian-linux.yml\n./bin/gbuild --commit sbit=${COMMIT} --url sbit=${URL} ../sbit/contrib/gitian-descriptors/gitian-win.yml\n./bin/gbuild --commit sbit=${COMMIT} --url sbit=${URL} ../sbit/contrib/gitian-descriptors/gitian-osx.yml\n# if wanting to use a different version of eth-cpp-sbit:\n./bin/gbuild --commit sbit=${COMMIT},cpp-eth-sbit=${ETHCOMMIT} --url sbit=${URL},cpp-eth-sbit=${ETHURL} ../sbit/contrib/gitian-descriptors/gitian-linux.yml\n")),(0,r.kt)("h2",{id:"building-fully-offline"},"Building fully offline"),(0,r.kt)("p",null,"For building fully offline including attaching signatures to unsigned builds, the detached-sigs repository\nand the sbit git repository with the desired tag must both be available locally, and then gbuild must be\ntold where to find them. It also requires an apt-cacher-ng which is fully-populated but set to offline mode, or\nmanually disabling gitian-builder's use of apt-get to update the VM build environment."),(0,r.kt)("p",null,"To configure apt-cacher-ng as an offline cacher, you will need to first populate its cache with the relevant\nfiles. You must additionally patch target-bin/bootstrap-fixup to set its apt sources to something other than\nplain archive.ubuntu.com: us.archive.ubuntu.com works."),(0,r.kt)("p",null,"So, if you use LXC:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'export PATH="$PATH":/path/to/gitian-builder/libexec\nexport USE_LXC=1\ncd /path/to/gitian-builder\n./libexec/make-clean-vm --suite trusty --arch amd64\n\nLXC_ARCH=amd64 LXC_SUITE=trusty on-target -u root apt-get update\nLXC_ARCH=amd64 LXC_SUITE=trusty on-target -u root \\\n  -e DEBIAN_FRONTEND=noninteractive apt-get --no-install-recommends -y install \\\n  $( sed -ne \'/^packages:/,/[^-] .*/ {/^- .*/{s/"//g;s/- //;p}}\' ../sbit/contrib/gitian-descriptors/*|sort|uniq )\nLXC_ARCH=amd64 LXC_SUITE=trusty on-target -u root apt-get -q -y purge grub\nLXC_ARCH=amd64 LXC_SUITE=trusty on-target -u root -e DEBIAN_FRONTEND=noninteractive apt-get -y dist-upgrade\n')),(0,r.kt)("p",null,"And then set offline mode for apt-cacher-ng:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"/etc/apt-cacher-ng/acng.conf\n[...]\nOfflinemode: 1\n[...]\n\nservice apt-cacher-ng restart\n")),(0,r.kt)("p",null,"Then when building, override the remote URLs that gbuild would otherwise pull from the Gitian descriptors::"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"\ncd /some/root/path/\ngit clone https://github.com/SBit-Project/SBit-detached-sigs.git\n\nBTCPATH=/some/root/path/sbit\nSIGPATH=/some/root/path/sbit-detached-sigs\n\n./bin/gbuild --url sbit=${BTCPATH},signature=${SIGPATH} ../sbit/contrib/gitian-descriptors/gitian-win-signer.yml\n")),(0,r.kt)("h2",{id:"signing-externally"},"Signing externally"),(0,r.kt)("p",null,"If you want to do the PGP signing on another device, that's also possible; just define ",(0,r.kt)("inlineCode",{parentName:"p"},"SIGNER")," as mentioned\nand follow the steps in the build process as normal."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'    gpg: skipped "laanwj": secret key not available\n')),(0,r.kt)("p",null,"When you execute ",(0,r.kt)("inlineCode",{parentName:"p"},"gsign")," you will get an error from GPG, which can be ignored. Copy the resulting ",(0,r.kt)("inlineCode",{parentName:"p"},".assert")," files\nin ",(0,r.kt)("inlineCode",{parentName:"p"},"gitian.sigs")," to your signing machine and do"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"    gpg --detach-sign ${VERSION}-linux/${SIGNER}/sbit-linux-build.assert\n    gpg --detach-sign ${VERSION}-win/${SIGNER}/sbit-win-build.assert\n    gpg --detach-sign ${VERSION}-osx-unsigned/${SIGNER}/sbit-osx-build.assert\n")),(0,r.kt)("p",null,"This will create the ",(0,r.kt)("inlineCode",{parentName:"p"},".sig")," files that can be committed together with the ",(0,r.kt)("inlineCode",{parentName:"p"},".assert")," files to assert your\nGitian build."),(0,r.kt)("h2",{id:"uploading-signatures"},"Uploading signatures"),(0,r.kt)("p",null,"After building and signing you can push your signatures (both the ",(0,r.kt)("inlineCode",{parentName:"p"},".assert")," and ",(0,r.kt)("inlineCode",{parentName:"p"},".assert.sig")," files) to the\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/SBit-Project/gitian.sigs/"},"SBit-Project/gitian.sigs")," repository, or if that's not possible create a pull\nrequest."))}h.isMDXComponent=!0}}]);